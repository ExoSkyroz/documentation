<html>
<head>
    <title>Documentation reader</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="bootstrap.min.css" />
    <link rel="stylesheet" href="default.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="tangular.min.js"></script>
    <script src="marked.min.js"></script>
    <script src="default.js"></script>
</head>
<body>

    <div class="container">
        <div class="row">
            <div class="col-sm-3 m">
                <div class="menu">
                    <div class="center"><a href="/"><img src="logo.png" class="image-responsive" alt="total.js web application framework for node.js" width="150" /></a></div>
                    <br />
                    <div class="search">
                        <input type="text" placeholder="Search ..." />
                    </div>
                    <div id="menu"></div>
                </div>
            </div>
            <div class="col-sm-9 m">
                <div class="content" id="content">
                </div>
            </div>
        </div>
    </div>

    <script type="text/html" id="template-menu">
        {{ if name }}
            <strong class="menu-group">{{ name }}</strong>
        {{ endif }}
        <ul>
            {{ foreach m in items }}
            <li><a href="{{ m.linker }}">{{ m.name }}</a></li>
            {{ end }}
        </ul>
        <br />
    </script>

    <script>

        var documentation;

        function reload() {
            var linker = decodeURIComponent(window.location.hash.substring(1)).split('~');
            render(linker[0], linker[1]);
        }

        function configure() {

            var pages = documentation['pages'];
            var api = documentation['api'];
            var links = documentation['links'];

            var gp = {}, ga = {}, gl = [];

            for (var i = 0, length = pages.length; i < length; i++) {
                var obj = pages[i];
                if (!obj.group)
                    obj.group = '';
                obj.linker = '#' + encodeURIComponent('pages~' + obj.name);
                if (gp[obj.group] === undefined)
                    gp[obj.group] = [obj];
                else
                    gp[obj.group].push(obj);
            }

            for (var i = 0, length = api.length; i < length; i++) {
                var obj = api[i];
                obj.linker = '#' + encodeURIComponent('api~' + obj.name);
                if (!obj.group)
                    obj.group = '';
                if (ga[obj.group] === undefined)
                    ga[obj.group] = [obj];
                else
                    ga[obj.group].push(obj);
            }

            for (var i = 0, length = links.length; i < length; i++) {
                var obj = links[i];
                obj.linker = obj.url;
                gl.push(obj);
            }

            var menu = Tangular.compile($('#template-menu').html());
            var arr = Object.keys(gp);
            var el = $('#menu').empty();

            arr.sort(sort);
            gp[''].push.apply(gp[''], gl);

            for (var i = 0, length = arr.length; i < length; i++)
                el.append(menu({ name: arr[i], items: gp[arr[i]] }));

            arr = Object.keys(ga);

            for (var i = 0, length = arr.length; i < length; i++)
                el.append(menu({ name: arr[i], items: ga[arr[i]] }));
        }

        $.get('documentation.json', function(data) {
            documentation = data;
            if ((window.location.hash || '').length < 2)
                window.location.href = '#' + encodeURIComponent(documentation['default']);
            configure();
            reload();
        });

        window.onhashchange = reload;

        function render(type, name) {

            var arr = documentation[type];
            var item;

            for (var i = 0, length = arr.length; i < length; i++) {
                if (arr[i].name === name) {
                    item = arr[i];
                    break;
                }
            }

            if (!item)
                return;

            var menu = $('.menu');

            menu.find('.selected').removeClass('selected');
            menu.find('a[href="' + item.linker + '"]').addClass('selected');

            $('#content').html('<h1>' + item.name + '</h1><div class="markdown">' + marked(item.body.replace(/‘|’/g, '\'')) + '</div>');
            highlight();
        }

        function sort(a, b) {
            if (a === '')
                return -1;
            if (b === '')
                return -1;
            return a.localeCompare(b);
        }

    </script>

</body>
</html>